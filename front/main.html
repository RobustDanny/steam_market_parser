<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="/front/main_page.css">
<style>
</style>

</head>

<body>

<script>
const ws = new WebSocket("ws://127.0.0.1:8080/ws");
const ws_ad = new WebSocket("ws://127.0.0.1:8080/ws/ads");

ws_ad.onopen = () => console.log("WS_AD CONNECTED");
ws_ad.onclose = () => console.log("WS_AD CLOSED");
ws_ad.onerror = (err) => console.log("WS_AD ERROR", err);

ws_ad.onmessage = (event) => {
    const data = JSON.parse(event.data);

    // Get only the FIRST ad
    const user_ad = data.user_ads?.[0];
    // if (!user_ad) return;
    
    const container = document.getElementById("items-container");

    // console.log("USER AD:", user_ad);
    container.insertAdjacentHTML("afterbegin", `
        <div class="card_hover-container">
          <div class="ad_card">
            <div class="ad_image_container">
              <img src=${user_ad.first_item_image} class="ad_card_image">
              <img src=${user_ad.second_item_image} class="ad_card_image">
              <img src=${user_ad.third_item_image} class="ad_card_image">
              <img src=${user_ad.fourth_item_image} class="ad_card_image">
            </div>
          </div>
        </div>
    `);
};

ws.onopen = () => console.log("WS CONNECTED");
ws.onclose = () => console.log("WS CLOSED");
ws.onerror = (err) => console.log("WS ERROR", err);

ws.onmessage = (event) => {
  const items = JSON.parse(event.data);

    console.log("Received update:", items);

    const container = document.getElementById("items-container");

    items.items.forEach(item => {

      const card = `
        <div class="card_hover-container">
          <div class="card">
              <div class="card-details">
                  <img class="game_icon" src="${item.game_icon}">
              <div>

              <div class="card_tooltip-container">
                  <img class="more_icon" src="/front/svg/more_icon.svg">

                  <span class="tooltip_actions">
                      <a href="https://steamcommunity.com/market/listings/${item.appid}/${item.market_hash_name}"
                      target="_blank" rel="noopener noreferrer">
                      <img class="tooltip_icon" src="/front/svg/grab_icon.svg">
                      </a>
                      <img class="tooltip_icon" src="/front/svg/info_icon.svg">
                  </span>
              </div>
              <div style="overflow: hidden;">
              <img src="https://steamcommunity.com/economy/image/${ item.icon }" alt="${ item.name }" class="item_icon">
              </div>
              </div>
              <span class="hidden-text">${item.name}</span>
              <span class="text-price">$${item.price}</span>
              </div>
          </div>
        </div>
      `;
        
      container.insertAdjacentHTML("afterbegin", card);        

    });
};
</script>

<script>
    function updateFilters() {
    
        const msg = {
            type: "filters",
            appid: document.getElementById("f_appid").value,
            price_min: document.getElementById("f_min").value,
            price_max: document.getElementById("f_max").value,
            query: document.getElementById("f_query").value,
        }
        ws.send(JSON.stringify(msg));
        
        const url = `/api/filters?appid=${msg.appid}&price_min=${msg.price_min}&price_max=${msg.price_max}&query=${msg.query}`;
    
        fetch(url)
            .then(res => res.json())
            .then(json => {
                console.log("Filters updated:", json);
            });
    }
</script>

<!-- === INITIAL TERA RENDER === -->
<div class="side_panel">
        <div class="side_panel_filters">
          <!-- <img class="side_panel_icon" src="/front/svg/filter_icon.svg"> -->

          <div class="filters">
            <label>Filters</label>
            <hr />
            <div class="filter_card cart">
                <div class="steps">
                  <div class="step">
                    <!-- <hr /> -->
                    <input
                    id="f_appid"
                    class="input_field"
                    placeholder="Enter a game"
                    type="text"
                  />
                  <!-- <hr /> -->
                  <input
                    id="f_query"
                    class="input_field"
                    placeholder="Enter a query"
                    type="text"
                  />
                    <!-- <hr /> -->
                  <label>min price</label>
                    <input
                    id="f_min"
                    type="range"
                    min="0"
                    max="9999999"
                    value="0"
                  />
                  <!-- <hr /> -->
                  <label>max price</label>
                    <input
                    id="f_max"
                    min="0"
                    max="9999999"
                    value="9999999"
                    type="range"
                  />
                  <!-- <hr /> -->
                  </div>
                </div>
      
            </div>
            <div class="filter_card checkout">
                <div class="footer">
                  <button class="checkout-btn" onclick="updateFilters()">Apply</button>
                </div>
            </div>

            <hr />
        </div>
        </div>

        <!-- <img class="side_panel_icon" src="/front/svg/chart_icon.svg">
        <img class="side_panel_icon" src="/front/svg/budget_icon.svg"> -->
    
</div>

<div class="head_panel">
  <div class="sign_in_container">
    {% if steam_user %}
    <div class="hidded_button" id="adMeBtn">
      <img src="/front/svg/ad_me_icon.svg" class="steam_user_avatar ads">
    </div>
    <div class="hidded_button_avatar">
      <img src="{{ steam_user.avatar_url_full }}" class="steam_user_avatar">
      <div class="hidden_user_tooltip">
        <div id="open_setting_form">
          <img src="/front/svg/user_settings.svg" class="user_settings_icons">
          <span style="color: #9E9E9E;">settings</span>
      </div>
        <a href="/api/logout">
        <div>
          <img src="/front/svg/user_logout.svg" class="user_settings_icons">
        <span style="color: #9E9E9E;">logout</span>
        </div>
        </a>
      </div>
    </div>
    <img class="sign_in_icon" src="/front/svg/ad_me_icon.svg">
    <img class="sign_in_icon" src="{{ steam_user.avatar_url_full }}">
    {% else %}
    <div class="hidded_button">
      <a href="http://localhost:8080/api/auth/steam">
        <img src="https://community.akamai.steamstatic.com/public/images/signinthroughsteam/sits_01.png">
      </a>
    </div>
    <img class="sign_in_icon" src="/front/svg/steam_icon.svg">
    {% endif %}
  </div>
</div>

<div class="event_container">
</div>

<div class="media_container">
  
  <!-- <div class="media_icons_play_cont">
    <img class="play_icon" src="/front/svg/play_icon.svg">
    <span class="hidden-text">Resume feed</span>
  </div> -->
  
  <div class="arrow_up_cont">
    <img class="arrows_icons" src="/front/svg/arrow_up.svg">
    <span class="hidden-text">Next event</span>
  </div>

  <div class="media_icons_pause_cont">
    <img class="pause_icon" src="/front/svg/pause_icon.svg">
    <span class="hidden-text">Pause feed</span>
  </div>
  
  <div class="arrow_down_cont">
      <img class="arrows_icons" src="/front/svg/arrow_down.svg">
      <span class="hidden-text">Previous event</span>
  </div>
</div>


<div id="items-container" class="items-container">    
{% for item in most_recent_items %}
        {% if filters.appid == item.game %}
        <div class="card_hover-container">

        <div class="card">
            <div class="card-details">
                <span class="text-price">${{ item.price }}</span>

                <div class="card_tooltip-container">
                    <img class="more_icon" src="/front/svg/more_icon.svg">
    
                    <span class="tooltip_actions">
                        <a href="https://steamcommunity.com/market/listings/{{item.appid}}/{{item.market_hash_name}}"
                        target="_blank" rel="noopener noreferrer">
                        <img class="tooltip_icon" src="/front/svg/grab_icon.svg">
                        </a>
                        <img class="tooltip_icon" src="/front/svg/info_icon.svg">
                    </span>
                </div>

                {% if item.tradable == "1" %}
                <img class="locker_icon" src="/front/svg/locker_icon.svg">
                {% endif %}
                
                <div>
                    <img class="game_icon" src="{{ item.game_icon }}">
                    <!-- <span class="hidden-text">{{item.game}}</span> -->
                </div>
                <div style="display: flex;
                box-sizing: content-box;">
                    <img src="https://steamcommunity.com/economy/image/{{ item.icon }}" alt="{{ item.name }}" class="item_icon">
                </div>
                <!-- <span class="text-title">{{ item.name }}</span> -->
                <span class="hidden-text">{{item.name}}</span>
            </div>
        </div>

        </div>
        {% endif %}
{% endfor %}
</div>
</div>


<!-- Settings -->>
<div class="modal_backdrop" id="settings_form">
  <form id="SettingsFormModal" class="modal_form">
    <span>inventory status</span>
    
    <button type="submit">Save</button>
  </form>
</div>

<!-- Ad me form -->
<div class="modal_backdrop" id="formModal">
  <div class="main_modal_form">
    <div style="display: flex; flex-direction: row; gap: 10px; justify-content: space-between;">
    <form class="load_inventory_modal_form" id="SettingsFormInventory">
      <div style="display: flex; flex-direction: row; gap: 10px;">
        <input style="display: none;" name="settings_steamid" value="{% if steam_user %}{{ steam_user.steamid }}{% endif %}">
      <input value="730" name="settings_appid">
      <button type="submit">load</button>
      </div>
    </form>
  <form id="adFormModal" class="card_view_modal_form">
    <input id="ad_steamid" type="text" name="steamid" style="display: none;" value="{% if steam_user %}{{ steam_user.steamid }}{% endif %}">
    <input id="ad_nickname" type="text" name="nickname" style="display: none;" value="{% if steam_user %}{{ steam_user.nickname }}{% endif %}">
    <input id="ad_avatar" type="text" name="avatar" style="display: none;" value="{% if steam_user %}{{ steam_user.avatar_url_full }}{% endif %}">

    <label style="display: flex; justify-self: center;">Store face</label>
    <div class="card_hover-container">
      <div class="ad_card">
        <div class="ad_image_container">
          {% if user_ad %}
          <img src="{{ user_ad.first_item_image }}" class="ad_card_image" data-slot="ad_first_item">
          <img src="{{ user_ad.second_item_image }}" class="ad_card_image" data-slot="ad_second_item">
          <img src="{{ user_ad.third_item_image }}" class="ad_card_image" data-slot="ad_third_item">
          <img src="{{ user_ad.fourth_item_image }}" class="ad_card_image" data-slot="ad_fourth_item">
          <input id="ad_first_item" type="hidden" name="first_item_image">
          <input id="ad_second_item" type="hidden" name="second_item_image">
          <input id="ad_third_item" type="hidden" name="third_item_image">
          <input id="ad_fourth_item" type="hidden" name="fourth_item_image">
      {% else %}
        <img src="/front/svg/default_item_icon.svg" class="ad_card_image" data-slot="ad_first_item">
        <img src="/front/svg/default_item_icon.svg" class="ad_card_image" data-slot="ad_second_item">
        <img src="/front/svg/default_item_icon.svg" class="ad_card_image" data-slot="ad_third_item">
        <img src="/front/svg/default_item_icon.svg" class="ad_card_image" data-slot="ad_fourth_item">
        <input id="ad_first_item" type="hidden" name="first_item_image">
        <input id="ad_second_item" type="hidden" name="second_item_image">
        <input id="ad_third_item" type="hidden" name="third_item_image">
        <input id="ad_fourth_item" type="hidden" name="fourth_item_image">
      {% endif %}
        </div>
      </div>
    </div>

    <button type="submit">Apply</button>
  </form>
  </div>
  <hr/>
  <div style="justify-content: center; display: flex;">
    <input class="ad_input_field">
  </div>
  <hr/>

  <div id="user_inventory" class="user_inventory">
    <span>No items yet</span>
</div>
  </div>
</div>

<script>
  document.getElementById("SettingsFormInventory").addEventListener("submit", async (e) => {
    e.preventDefault();

    const form = e.target;
    const data = new URLSearchParams(new FormData(form));

    const res = await fetch("/api/get_inventory_items", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: data
    });

    const json = await res.json();
    console.log("Inventory loaded:", json);

    renderUserInventory(json);
  });

  function renderUserInventory(inventory) {
    const container = document.getElementById("user_inventory");

    container.innerHTML = ""; // clear old inventory

    const assets = inventory.assets || [];
    const descriptions = inventory.descriptions || [];

    // Quick lookup by classid+instanceid
    const descMap = {};
    descriptions.forEach(d => {
        const key = `${d.classid}_${d.instanceid}`;
        descMap[key] = d;
    });

    assets.forEach(asset => {
        const key = `${asset.classid}_${asset.instanceid}`;
        const desc = descMap[key];

        if (!desc) return;

        const icon = `https://steamcommunity.com/economy/image/${desc.icon_url}`;
        const name = desc.name || "Unknown item";

        const card = `
            <div class="card_hover-container inventory-select" data-image="${icon}">
                <div class="inventory_card">
                    <div class="inventory_card_details">

                        <div>
                            <img class="inventory_item_icon" src="${icon}" alt="${name}">
                        </div>

                        <span class="hidden-text">${name}</span>
                    </div>
                </div>
            </div>
        `;

        container.insertAdjacentHTML("beforeend", card);
    });
}

document.addEventListener("click", (e) => {
    const card = e.target.closest(".inventory-select");
    if (!card) return;

    const img = card.dataset.image;

    // Find all ad slots
    const slots = document.querySelectorAll(".ad_card_image");

    // Find first empty slot (default icon)
    let emptySlot = Array.from(slots).find(s => 
        s.src.includes("default_item_icon") || s.src === ""
    );

    // If no empty slot â†’ replace the first one
    if (!emptySlot) emptySlot = slots[0];

    emptySlot.src = img;

    // Also push into hidden form fields if needed
    const id = emptySlot.dataset.slot;
    if (id) {
        document.getElementById(id).value = img;
    }
});

</script>

<script>
  document.getElementById("open_setting_form")?.addEventListener("click", () => {
    document.getElementById("settings_form").style.display = "flex";
  });

document.getElementById("settings_form").addEventListener("click", (e) => {
    if (e.target === document.getElementById("settings_form")) {
        document.getElementById("settings_form").style.display = "none"; 
    }
});

  document.getElementById("adMeBtn")?.addEventListener("click", () => {
    document.getElementById("formModal").style.display = "flex";
  });
  
  document.getElementById("formModal").addEventListener("click", (e) => {
    if (e.target.id === "formModal") {
      e.target.style.display = "none";
    }
  });

  document.getElementById("adFormModal").addEventListener("submit", async (e) => {
    e.preventDefault();

    const form = e.target;
    const data = new URLSearchParams(new FormData(form));

    const res = await fetch("/api/add_to_ad_queue", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: data
    });

    const json = await res.json();
    console.log("Ad added:", json);

    document.getElementById("formModal").style.display = "none";
});
</script>

</body>
</html>
